#!/usr/bin/env python3

# See https://www.reddit.com/r/git/comments/ah1euu
import _gitz

USAGE = """\
git-snip: Delete one or more commits IDs from the current branch

USAGE:
    git-snip <id> [<id> ...]
"""
HELP = """"
Delete one or more commits IDs from the current branch.
IDs 0, 1, 2, 3... are short for HEAD~0, HEAD~1, HEAD~2, HEAD~3...

This command rewrites history - only intended for use on private
branches.

"""
GIT = _gitz.GIT
PROGRAM = _gitz.Program(USAGE, HELP)


def git_snip(*argv):
    indexes = []
    errors = []
    dupes = []
    indexer = _gitz.CommitIndexer()

    for a in argv:
        try:
            index = indexer.index(a)
            if index in indexes:
                dupes.append(a)
            else:
                indexes.append(index)
        except Exception:
            errors.append(a)

    if errors:
        PROGRAM.error('Not commit IDs:', *errors)
    if dupes:
        PROGRAM.error('Duplicate IDs:', *dupes)
    if errors or dupes:
        PROGRAM.exit()

    for i in reversed(sorted(indexes)):
        'HEAD~%s' % i
        GIT.rebase(('HEAD~%s' % i), '--onto', 'HEAD~%s' % (i + 1))


if __name__ == '__main__':
    PROGRAM.exit_on_help()
    git_snip(*PROGRAM.argv)
